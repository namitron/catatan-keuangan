<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catatan Keuangan</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Gaya untuk body dan canvas */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow-x: hidden; /* Mencegah scrollbar horizontal */
        }
        #canvas-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%; /* Mengatur lebar canvas menjadi 100% */
            height: 100%; /* Mengatur tinggi canvas menjadi 100% */
            z-index: -1; /* Menempatkan canvas di belakang konten */
        }

        .container {
            position: relative;
            z-index: 1; /* Menempatkan konten di atas canvas */
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.8); /* Memberikan latar belakang putih transparan */
            border-radius: 10px; /* Menambahkan sudut melengkung */
            max-width: 1200px; /* Menentukan lebar maksimum kontainer */
            margin: auto; /* Mengatur margin agar kontainer berada di tengah */
        }

        /* Gaya untuk grafik */
        #chart-container {
            width: 100%; /* Lebar grafik mengikuti kontainer */
            margin: auto;
            padding-top: 20px; /* Menambahkan jarak di atas grafik */
            height: 400px; /* Tinggi container grafik */
        }

        canvas {
            width: 100% !important; /* Membuat grafik responsif sesuai dengan lebar kontainer */
            height: 100% !important; /* Membuat grafik responsif sesuai dengan tinggi kontainer */
        }

        table {
            width: 100%; /* Mengatur tabel agar lebar 100% dari kontainer */
            border-collapse: collapse; /* Menghapus spasi antara sel tabel */
        }

        th, td {
            border: 1px solid #ccc; /* Menambahkan border pada tabel */
            padding: 8px; /* Menambahkan padding di dalam sel */
            text-align: left; /* Mengatur teks di dalam sel ke kiri */
        }
    </style>
</head>
<body>
    <canvas id="canvas-bg"></canvas> <!-- Menambahkan canvas untuk background -->
    
    <div class="container">
        <h1>Catatan Keuangan</h1>
        
        <form id="form">
            <input type="text" id="description" placeholder="Deskripsi" required>
            <input type="number" id="amount" placeholder="Jumlah" required>
            <select id="type">
                <option value="income">Pemasukan</option>
                <option value="expense">Pengeluaran</option>
            </select>
            <button type="submit">Tambah</button>
        </form>

        <table>
            <thead>
                <tr>
                    <th>Deskripsi</th>
                    <th>Jumlah</th>
                    <th>Tipe</th>
                    <th>Waktu</th>
                    <th>Saldo</th> <!-- Menambahkan kolom saldo -->
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="transaction-table">
            </tbody>
        </table>

        <div class="summary">
            <h2>Ringkasan</h2>
            <p>Pemasukan: <span id="income-total">Rp 0</span></p>
            <p>Pengeluaran: <span id="expense-total">Rp 0</span></p>
            <p>Saldo: <span id="balance">Rp 0</span></p>
        </div>

        <button id="download-button">Unduh Excel</button>
        
        <!-- Menambahkan container untuk grafik -->
        <div id="chart-container">
            <canvas id="myChart"></canvas>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
      // Import Firebase SDK
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
      import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCThcGVbqaOSvDhWARk0-4Icqxt95vuVgY",
        authDomain: "catatan-67be8.firebaseapp.com",
        projectId: "catatan-67be8",
        storageBucket: "catatan-67be8.appspot.com",
        messagingSenderId: "481382304833",
        appId: "1:481382304833:web:4004daa9d8d4daed440ac0"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      // DOM Elements
      const form = document.getElementById('form');
      const transactionTable = document.getElementById('transaction-table');
      const incomeTotalDisplay = document.getElementById('income-total');
      const expenseTotalDisplay = document.getElementById('expense-total');
      const balanceDisplay = document.getElementById('balance');
      const downloadButton = document.getElementById('download-button');

      let transactions = [];

      // Listen for transactions in Firebase
      onValue(ref(database, 'transactions'), (snapshot) => {
          const data = snapshot.val();
          transactions = [];
          transactionTable.innerHTML = '';

          for (let key in data) {
              const transaction = data[key];
              transactions.push({ ...transaction, id: key });
              displayTransaction({ ...transaction, id: key });
          }

          updateSummary();
          updateChart(); // Memperbarui grafik setelah data transaksi diambil
      });

      // Add new transaction
      form.addEventListener('submit', function(e) {
          e.preventDefault();

          const description = document.getElementById('description').value.trim();
          const amount = parseFloat(document.getElementById('amount').value);
          const type = document.getElementById('type').value;
          const timestamp = Date.now(); // Menambahkan timestamp

          // Input validation
          if (description === '' || isNaN(amount) || amount <= 0) {
              alert('Silakan masukkan deskripsi dan jumlah yang valid.');
              return;
          }

          const transaction = {
              description,
              amount,
              type,
              timestamp
          };

          // Push transaction to Firebase
          push(ref(database, 'transactions'), transaction)
              .then(() => {
                  console.log('Transaksi berhasil ditambahkan');
                  form.reset(); // Reset form setelah berhasil
              })
              .catch((error) => {
                  console.error('Error menambahkan transaksi:', error);
              });
      });

      // Display transaction in table
      function displayTransaction(transaction) {
          const row = document.createElement('tr');
          const saldo = calculateBalance(transaction.id); // Menghitung saldo
          row.innerHTML = `
              <td>${transaction.description}</td>
              <td>Rp ${transaction.amount}</td>
              <td>${transaction.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}</td>
              <td>${new Date(transaction.timestamp).toLocaleString('id-ID')}</td>
              <td>Rp ${saldo}</td> <!-- Menambahkan kolom saldo -->
              <td><button onclick="removeTransaction('${transaction.id}')">Hapus</button></td>
          `;
          transactionTable.appendChild(row);
      }

      // Calculate balance based on transactions
      function calculateBalance(currentId) {
          const filteredTransactions = transactions.filter(t => {
              return t.id <= currentId; // Mengambil transaksi sebelum dan termasuk transaksi saat ini
          });
          const incomeTotal = filteredTransactions
              .filter(transaction => transaction.type === 'income')
              .reduce((acc, transaction) => acc + transaction.amount, 0);

          const expenseTotal = filteredTransactions
              .filter(transaction => transaction.type === 'expense')
              .reduce((acc, transaction) => acc + transaction.amount, 0);

          return incomeTotal - expenseTotal;
      }

      // Remove transaction from Firebase
      window.removeTransaction = function(id) {
          remove(ref(database, 'transactions/' + id));
      }

      // Update income, expense, and balance
      function updateSummary() {
          const incomeTotal = transactions
              .filter(transaction => transaction.type === 'income')
              .reduce((acc, transaction) => acc + transaction.amount, 0);

          const expenseTotal = transactions
              .filter(transaction => transaction.type === 'expense')
              .reduce((acc, transaction) => acc + transaction.amount, 0);

          const balance = incomeTotal - expenseTotal;

          incomeTotalDisplay.textContent = `Rp ${incomeTotal}`;
          expenseTotalDisplay.textContent = `Rp ${expenseTotal}`;
          balanceDisplay.textContent = `Rp ${balance}`;
      }

      // Download data to Excel
      downloadButton.addEventListener('click', function() {
          const data = transactions.map(transaction => ({
              Deskripsi: transaction.description,
              Jumlah: transaction.amount,
              Tipe: transaction.type === 'income' ? 'Pemasukan' : 'Pengeluaran',
              Waktu: new Date(transaction.timestamp).toLocaleString('id-ID'),
              Saldo: calculateBalance(transaction.id) // Menambahkan saldo ke data
          }));

          const worksheet = XLSX.utils.json_to_sheet(data);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, "Transaksi");

          // Generate buffer and create file download
          XLSX.writeFile(workbook, "catatan_keuangan.xlsx");
      });

      // Chart.js
      const ctx = document.getElementById('myChart').getContext('2d');
      const myChart = new Chart(ctx, {
          type: 'line',
          data: {
              labels: [], // Labels akan diisi dari transaksi
              datasets: [{
                  label: 'Pemasukan',
                  data: [],
                  borderColor: 'rgba(0, 255, 0, 1)',
                  backgroundColor: 'rgba(0, 255, 0, 0.2)',
                  fill: true
              }, {
                  label: 'Pengeluaran',
                  data: [],
                  borderColor: 'rgba(255, 0, 0, 1)',
                  backgroundColor: 'rgba(255, 0, 0, 0.2)',
                  fill: true
              }, {
                  label: 'Saldo',
                  data: [],
                  borderColor: 'rgba(0, 0, 255, 1)',
                  backgroundColor: 'rgba(0, 0, 255, 0.2)',
                  fill: true
              }]
          },
          options: {
              responsive: true,
              scales: {
                  x: {
                      type: 'time', // Menggunakan tipe waktu untuk sumbu X
                      time: {
                          unit: 'day' // Unit waktu
                      }
                  },
                  y: {
                      beginAtZero: true
                  }
              }
          }
      });

      // Update chart with transactions data
      function updateChart() {
          const labels = transactions.map(transaction => new Date(transaction.timestamp));
          const incomeData = transactions.filter(t => t.type === 'income').map(t => t.amount);
          const expenseData = transactions.filter(t => t.type === 'expense').map(t => t.amount);
          const balanceData = [];

          // Hitung saldo kumulatif
          let cumulativeBalance = 0;
          for (let i = 0; i < transactions.length; i++) {
              if (transactions[i].type === 'income') {
                  cumulativeBalance += transactions[i].amount;
              } else {
                  cumulativeBalance -= transactions[i].amount;
              }
              balanceData.push(cumulativeBalance);
          }

          // Update data grafik
          myChart.data.labels = labels;
          myChart.data.datasets[0].data = incomeData;
          myChart.data.datasets[1].data = expenseData;
          myChart.data.datasets[2].data = balanceData;
          myChart.update(); // Refresh grafik
      }

      // Memperbarui grafik setiap kali data transaksi berubah
      onValue(ref(database, 'transactions'), (snapshot) => {
          const data = snapshot.val();
          transactions = [];
          transactionTable.innerHTML = '';

          for (let key in data) {
              const transaction = data[key];
              transactions.push({ ...transaction, id: key });
              displayTransaction({ ...transaction, id: key });
          }

          updateSummary();
          updateChart(); // Memperbarui grafik
      });
    </script>
</body>
</html>
